<div class="body">
<div class="container">
	<div clas="row">
		<h1><h2><%= @cd.cd_title %></h2></h1>
		<div class="col-lg-4">
			<%= attachment_image_tag(@cd, :cd_image, :fill, 300, 300) %>
		</div>
		<div class="col-lg-8">
			<p><%= @cd.cd_profile %></p>
		</div>
	</div>
</div>
<div class="container">
	<div clas="row">
		<div class="col-lg-6">
			<strong><%= @cd.cd_title %></strong>
			<p><%= link_to @cd.artist.artist_name, artist_path(@cd.artist.id) %></p>
			<p>価格: <%= @cd.price %></p>
			<% if user_signed_in? && current_user.admin?  %>
				<p>在庫数: <%= @cd.stock %></p>
			<% end %>

			<div>
				<% if user_signed_in? %>
					<div class="inline-block">
							<%= form_for(@cart_item, url:cart_item_path) do |f| %>
								<div class="inline-block">
									<p>数量: <%= f.number_field :quantity, class: "form-control" %></p>
								</div>
								<div class="inline-block">
									<%= button_tag type: 'submit', class: "btn" do %>
										<i class="fas fa-cart-arrow-down" style="font-size:30px;"></i>
									<% end %>
								</div>
							<% end %>
					</div>

					<div class="inline-block">
						<% if @cd.favorited_by?(current_user) %>
							<div>
								<%= link_to cd_favorite_path(@cd), method: :delete do %>
								<i class="far fa-heart" aria-hidden="true" style="color: red;"></i><%= @cd.favorites.count %>
								<% end %>
							</div>
						<% else %>
							<div>
							<%= link_to cd_favorite_path(@cd), method: :post do %><%= @cd.favorites.count %>
							<i class="far fa-heart" aria-hidden="true"></i>
							<% end %>
							</div>
						<% end %>
					</div>
			<% else %>
					<div class="inline-block">
							<%= form_for(@cart_item) do |f| %>
								<div class="inline-block">
									<p>数量: <%= f.number_field :quantity, class: "form-control" %></p>
								</div>
								<%= f.hidden_field :user_id, value: "0" %>
								<div class="inline-block">
									<%= button_to add_item_path(cd.id), method: :post do %>
										<i class="fas fa-cart-arrow-down" style="font-size:30px;"></i>
									<% end %>
								</div>
							<% end %>
					</div>

					<div class="inline-block">

						<button type="button" data-toggle="modal" data-target="#exampleModal">
  							<i class="far fa-heart" aria-hidden="true"></i>
						</button>
						<%= @cd.favorites.count %>

						<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  							<div class="modal-dialog" role="document">
    							<div class="modal-content">
      								<div class="modal-header">
       									 <h5 class="modal-title" id="exampleModalLabel">いいねを押すにはログインしてください。</h5>
        								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
         									<span aria-hidden="true">&times;</span>
      									</button>
      								</div>
      								<div class="modal-body">
      									<%= link_to "Log In", new_user_session_path, class: "btn btn-default btn-sm" %>
      									<%= link_to "Sign Up", new_user_registration_path, class: "btn btn-default btn-sm" %>
      								</div>
      								<div class="modal-footer">
       									<button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
      								</div>
    							</div>
  							</div>
						</div>
					</div>

						<button type="button" data-toggle="modal" data-target="#exampleModal" class="btn btn-default btn-sm">
  							<i class="far fa-heart" aria-hidden="true"></i>
						</button>
						<%= @cd.favorites.count %>
						<%= render 'modal' %>
					</div>


			<% end %>

				<% if user_signed_in? && current_user.admin?  %>
					<div class="inline-block">
						<%= link_to "編集", edit_cd_path(@cd.id), class: "btn btn-default" %>
						<%= link_to "削除", cd_path(@cd.id), method: :delete, class: "btn btn-default" %>
					</div>
				<% end %>
			</div>

			<div>
				<h3>コメント一覧</h3>
				<div>
					<% if @cd.comments.present? %>
						<table>
						<% @cd.comments.each do |comment| %>
							<tr>
								<td>
									<strong><%= comment.user_id %>さんのコメント『<%= comment.comment_body %>』（CDのid: <%= comment.cd_id %>、コメントのId: <%= comment.id %>)</strong>
									<% comeid = comment.id %>
									<% if comment.user == current_user %>
									<button class="toEditForm">編集</button>
										<div class="EditForm">
											<%= form_for(comment) do |f| %>
												<div>
													<%= f.label :comment_body %>
  													<%= f.text_field :comment_body, class: "form-control" %>
  													<%= f.hidden_field :cd_id, value: @cd.id %>
  												</div>
  													<%= f.submit  class: "btn btn-default" %>
											<% end %>
										</div>
									<% end %>
										<% if user_signed_in? %>
										<% if current_user.admin? || comment.user == current_user %>
											<%= link_to "コメントを削除しますか?", cd_comment_path(@cd.id,comeid.to_i), method: :delete, data: {confirm: '本当に削除しますか'} %>
										<% end %>
										<% end %>
										<% if comment.comment_replies.present? %>
										<table>
										<% comment.comment_replies.each do |rep| %>
											<tr>
												<td>コメントID: <%= rep.comment.id %></td>
												<td>ユーザーId: <%= rep.user_id %></td>
												<td><strong><%= rep.comment_reply_body %></strong></td>
												<td>Id: <%= rep.id %></td>
												<% if rep.user == current_user %>
												<td><button class="toEditForm">編集</button>
													<div class="EditForm">
														<% @rep = rep %>
															<%= form_for(@rep) do |f| %>
															<div>
																<%= f.label :comment_reply_body, "返信内容" %>
																<%= f.text_field :comment_reply_body, class: "form-control" %>
																<%= f.hidden_field :comment_id, value: comment.id %>
																<%= f.hidden_field :user_id, value: current_user.id %>
															</div>
																<%= f.submit %>
															<% end %>
													</div>
												</td>
												<% end %>
												<% if user_signed_in? %>
												<% if current_user.admin? || comment.user == current_user %>  %>
												<td><%= link_to "返信を削除しますか?", comment_reply_path(rep.id), method: :delete, data: {confirm: '本当に削除しますか?'} %></td>
												<% end %>
											</tr>
										<% end %>
										<% end %>
										</table>
										<% end %>

									<% comeid = comment.id %>
									<% if user_signed_in? %>
									<button class="toReplyForm">返信</button>
									<div class="ReplyForm">
										<%= form_for [comment, @comment_reply], url: comment_comment_replies_path(comment_id: comeid.to_i) do |f| %>
											<div>
												<%= f.label :comment_reply_body, "返信内容" %>
												<%= f.text_field :comment_reply_body, class: "form-control" %>
												<%= f.hidden_field :comment_id, value: comment.id %>
												<%= f.hidden_field :user_id, value: current_user.id %>
											</div>
										<%= f.submit %>
										<% end %>

									</div>
									<% else %>
										<strong><%= link_to "返信するためにはログインしてください!", new_user_session_path %></strong>

									<% else %>
										<div class="inline-block">
											<button type="button" data-toggle="modal" data-target="#exampleModal" class="btn btn-default btn-sm">返信</button>
												<%= render 'modal' %>
										</div>
										</div>

									<% end %>
								</td>
							</tr>
						<% end %>
						</table>
					<% end %>
				</div>

<!-- New Comment -->
				<% if user_signed_in? %>
				<div>
				<%= form_for [@cd, @comment] do |f| %>
					<div>
					<%= f.label :comment_body, "コメント内容" %>
  					<%= f.text_field :comment_body, class: "form-control" %>
  					<%= f.hidden_field :cd_id, value: @cd.id %>
  					</div>
  					<%= f.submit "コメント送信", class: "btn btn-default" %>
				<% end %>
				</div>
				<% else %>

        
					<strong><%= link_to "コメントをするにはログインしてください!", new_user_session_path %></strong>
        
        
				<div class="inline-block">
					<button type="button" data-toggle="modal" data-target="#exampleModal" class="btn btn-default btn-sm">コメントを送る</button>
						<%= render 'modal' %>
				</div>
        
        
				<% end %>
<!-- [END] New Comment -->
			</div>
		</div>
	</div>
</div>

		</div>
		<div class="col-lg-6">
			AREA FOR SONGS
		</div>
	</div>
</div>

<div class="container">
	<div clas="row">
		<div class="col-lg-2">
			<%= link_to "CD一覧に戻る", cds_path, class: "btn btn-default" %>
		</div>
		<div class="col-lg-10">
		</div>
	</div>
</div>


<style>
	.ReplyForm, .EditForm {
		display: none;
	}
	.inline-block {
		display: inline-block;
	}
</style>